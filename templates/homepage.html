{% extends "base.html" %}

{% block title %}Home - Cookbook{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/homepage.css') }}">
{% endblock %}

{% block content %}
<div class="homepage-container">
    <h1>üè† Welcome to Your Cookbook</h1>
    
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h2>üìÖ This Week's Meals</h2>
            <div id="week-calendar" class="week-calendar">
                <div class="no-data">Loading...</div>
            </div>
        </div>
        
        <div class="dashboard-card">
            <h2>üõí Latest Grocery List</h2>
            <div class="add-item-section">
                <div class="add-item-form">
                    <div class="add-item-input">
                        <label>Item Name *</label>
                        <input type="text" id="new-item-name" placeholder="e.g., Milk">
                    </div>
                    <div class="add-item-input" style="max-width: 100px;">
                        <label>Amount</label>
                        <input type="text" id="new-item-amount" placeholder="e.g., 2">
                    </div>
                    <div class="add-item-input" style="max-width: 100px;">
                        <label>Unit</label>
                        <input type="text" id="new-item-unit" placeholder="e.g., gal">
                    </div>
                    <button class="add-item-btn" onclick="addCustomItem()">+ Add Item</button>
                </div>
            </div>
            <div id="grocery-date" class="grocery-date"></div>
            <div class="grocery-list-controls">
                <label class="clear-option">
                    <input type="checkbox" id="clear-completed-only" checked>
                    <span>Completed only</span>
                </label>
                <button class="clear-list-btn" onclick="clearGroceryList()">üóëÔ∏è Clear List</button>
            </div>
            <ul id="grocery-list" class="grocery-list">
                <li class="no-data">No grocery list generated yet</li>
            </ul>
        </div>
    </div>
</div>

<script>
    async function loadWeekMeals() {
        try {
            const response = await fetch('/api/current-week-meals');
            const meals = await response.json();
            
            const weekCalendar = document.getElementById('week-calendar');
            
            // Get current week dates
            const today = new Date();
            const dayOfWeek = today.getDay();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - dayOfWeek);
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            let weekHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = dateStr === today.toISOString().split('T')[0];
                
                const dayMeals = meals.filter(m => m.date === dateStr);
                
                let mealsHTML = '';
                const mealIcons = { breakfast: 'üç≥', lunch: 'ü•ó', dinner: 'üçù' };
                
                dayMeals.forEach(meal => {
                    if (meal.recipe_name) {
                        mealsHTML += `<div class="meal-item"><span class="meal-icon">${mealIcons[meal.meal_type] || 'üç¥'}</span>${meal.recipe_name}</div>`;
                    }
                });
                
                if (!mealsHTML) {
                    mealsHTML = '<div class="meal-item" style="opacity: 0.5;">No meals</div>';
                }
                
                weekHTML += `
                    <div class="week-day ${isToday ? 'today' : ''}">
                        <div class="week-day-header">${days[i]}</div>
                        <div class="week-day-date">${months[date.getMonth()]} ${date.getDate()}</div>
                        ${mealsHTML}
                    </div>
                `;
            }
            
            weekCalendar.innerHTML = weekHTML;
        } catch (error) {
            console.error('Error loading week meals:', error);
            document.getElementById('week-calendar').innerHTML = '<div class="no-data">Error loading meals</div>';
        }
    }
    
    async function loadGroceryList() {
        try {
            const response = await fetch('/api/grocery-list/latest');
            const data = await response.json();
            
            const groceryList = document.getElementById('grocery-list');
            const groceryDate = document.getElementById('grocery-date');
            
            // Load custom items from localStorage
            const customItems = JSON.parse(localStorage.getItem('customGroceryItems') || '[]');
            
            // Check if generated items should be hidden
            const hideGenerated = localStorage.getItem('hideGeneratedItems') === 'true';
            
            // Store both for rendering
            window.generatedItems = (data.success && !hideGenerated) ? data.items : [];
            window.customGroceryItems = customItems;
            
            if (data.success && !hideGenerated && data.items.length > 0) {
                const createdDate = new Date(data.created_at);
                groceryDate.textContent = `Generated on ${createdDate.toLocaleDateString()} at ${createdDate.toLocaleTimeString()}`;
                
                renderGroceryList();
            } else if (customItems.length > 0) {
                groceryDate.textContent = '';
                renderGroceryList();
            } else {
                groceryDate.textContent = '';
                groceryList.innerHTML = '<li class="no-data">No grocery list generated yet</li>';
            }
        } catch (error) {
            console.error('Error loading grocery list:', error);
        }
    }
    
    function renderGroceryList() {
        const groceryList = document.getElementById('grocery-list');
        const completedItems = JSON.parse(localStorage.getItem('completedGroceryItems') || '{}');
        const generatedItems = window.generatedItems || [];
        const customItems = window.customGroceryItems || [];
        
        let html = '';
        
        // Render generated items
        generatedItems.forEach((item, index) => {
            const itemId = `gen-${index}`;
            const isCompleted = completedItems[itemId] || false;
            const amountText = item.amount && item.unit ? `${item.amount} ${item.unit}` : (item.amount || item.unit || '');
            
            html += `
                <li class="${isCompleted ? 'completed' : ''}" data-item-id="${itemId}">
                    <input type="checkbox" class="grocery-item-checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleItemComplete('${itemId}')">
                    <div class="grocery-item-content">
                        <span class="grocery-item-name">${item.name}</span>
                        <span class="grocery-item-amount">${amountText}</span>
                    </div>
                    <button class="grocery-item-edit" onclick="editGroceryItem('gen', ${index})">Edit</button>
                </li>
            `;
        });
        
        // Render custom items
        customItems.forEach((item, index) => {
            const itemId = `custom-${index}`;
            const isCompleted = completedItems[itemId] || false;
            const amountText = item.amount && item.unit ? `${item.amount} ${item.unit}` : (item.amount || item.unit || '');
            
            html += `
                <li class="${isCompleted ? 'completed' : ''}" data-item-id="${itemId}">
                    <input type="checkbox" class="grocery-item-checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleItemComplete('${itemId}')">
                    <div class="grocery-item-content">
                        <span class="grocery-item-name">${item.name}</span>
                        <span class="grocery-item-amount">${amountText}</span>
                    </div>
                    <button class="grocery-item-edit" onclick="editGroceryItem('custom', ${index})">Edit</button>
                </li>
            `;
        });
        
        groceryList.innerHTML = html || '<li class="no-data">No items in list</li>';
    }
    
    function toggleItemComplete(itemId) {
        let completedItems = JSON.parse(localStorage.getItem('completedGroceryItems') || '{}');
        completedItems[itemId] = !completedItems[itemId];
        localStorage.setItem('completedGroceryItems', JSON.stringify(completedItems));
        renderGroceryList();
    }
    
    function addCustomItem() {
        const name = document.getElementById('new-item-name').value.trim();
        const amount = document.getElementById('new-item-amount').value.trim();
        const unit = document.getElementById('new-item-unit').value.trim();
        
        if (!name) {
            alert('Please enter an item name');
            return;
        }
        
        const customItems = JSON.parse(localStorage.getItem('customGroceryItems') || '[]');
        customItems.push({ name, amount, unit });
        localStorage.setItem('customGroceryItems', JSON.stringify(customItems));
        
        // Clear inputs
        document.getElementById('new-item-name').value = '';
        document.getElementById('new-item-amount').value = '';
        document.getElementById('new-item-unit').value = '';
        
        // Show generated items again if we're adding items
        localStorage.removeItem('hideGeneratedItems');
        
        loadGroceryList();
    }
    
    function editGroceryItem(type, index) {
        if (type === 'custom') {
            const customItems = JSON.parse(localStorage.getItem('customGroceryItems') || '[]');
            if (index >= 0 && index < customItems.length) {
                const item = customItems[index];
                const newName = prompt('Edit item name:', item.name);
                if (newName !== null && newName.trim()) {
                    item.name = newName.trim();
                    const newAmount = prompt('Edit amount (optional):', item.amount || '');
                    item.amount = newAmount !== null ? newAmount.trim() : item.amount;
                    const newUnit = prompt('Edit unit (optional):', item.unit || '');
                    item.unit = newUnit !== null ? newUnit.trim() : item.unit;
                    
                    customItems[index] = item;
                    localStorage.setItem('customGroceryItems', JSON.stringify(customItems));
                    loadGroceryList();
                }
            }
        } else {
            // For generated items, create a copy as custom item
            const generatedItems = window.generatedItems || [];
            if (index >= 0 && index < generatedItems.length) {
                const item = generatedItems[index];
                const newName = prompt('Edit item name:', item.name);
                if (newName !== null && newName.trim()) {
                    const customItems = JSON.parse(localStorage.getItem('customGroceryItems') || '[]');
                    customItems.push({
                        name: newName.trim(),
                        amount: prompt('Edit amount (optional):', item.amount || '') || '',
                        unit: prompt('Edit unit (optional):', item.unit || '') || ''
                    });
                    localStorage.setItem('customGroceryItems', JSON.stringify(customItems));
                    loadGroceryList();
                }
            }
        }
    }
    
    function clearGroceryList() {
        const completedOnly = document.getElementById('clear-completed-only').checked;
        
        if (completedOnly) {
            // Clear only completed items
            if (!confirm('Clear all completed items from the list?')) {
                return;
            }
            
            const completedItems = JSON.parse(localStorage.getItem('completedGroceryItems') || '{}');
            const customItems = JSON.parse(localStorage.getItem('customGroceryItems') || '[]');
            const generatedItems = window.generatedItems || [];
            
            // Filter out completed custom items
            const filteredCustomItems = [];
            customItems.forEach((item, index) => {
                const itemId = `custom-${index}`;
                if (!completedItems[itemId]) {
                    filteredCustomItems.push(item);
                }
            });
            
            // Filter out completed generated items
            const filteredGeneratedItems = [];
            generatedItems.forEach((item, index) => {
                const itemId = `gen-${index}`;
                if (!completedItems[itemId]) {
                    filteredGeneratedItems.push(item);
                }
            });
            
            // Update localStorage and window variables
            localStorage.setItem('customGroceryItems', JSON.stringify(filteredCustomItems));
            localStorage.removeItem('completedGroceryItems');
            window.generatedItems = filteredGeneratedItems;
            window.customGroceryItems = filteredCustomItems;
            
            renderGroceryList();
        } else {
            // Clear all items
            if (!confirm('Clear the entire grocery list? This will remove all items.')) {
                return;
            }
            
            localStorage.removeItem('customGroceryItems');
            localStorage.removeItem('completedGroceryItems');
            localStorage.setItem('hideGeneratedItems', 'true');
            window.generatedItems = [];
            window.customGroceryItems = [];
            
            const groceryList = document.getElementById('grocery-list');
            groceryList.innerHTML = '<li class="no-data">No grocery list generated yet</li>';
            document.getElementById('grocery-date').textContent = '';
        }
    }
    
    // Load data on page load
    loadWeekMeals();
    loadGroceryList();
</script>
{% endblock %}
