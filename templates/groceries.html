{% extends "base.html" %}

{% block title %}Groceries - Cookbook{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/groceries.css') }}">
{% endblock %}

{% block content %}
<div class="groceries-container">
    <h1>Grocery List Generator</h1>
    
    <div class="recipe-search-section">
        <h2>Select Recipes</h2>
        <div class="search-container">
            <input type="text" id="recipe-search" class="search-input" placeholder="Search for recipes..." autocomplete="off">
            <div id="search-dropdown" class="search-dropdown">
                <!-- Dropdown results will appear here -->
            </div>
        </div>
        <div id="selected-recipes" class="selected-recipes empty">
            <!-- Selected recipes will appear here -->
        </div>
    </div>
    
    <div class="ingredients-section">
        <h2>Ingredients</h2>
        <div id="ingredients-container">
            <div class="no-ingredients">Select recipes to see ingredients</div>
        </div>
    </div>
    
    <div class="grocery-list-section" id="grocery-list-section">
        <h2>üìù Your Grocery List</h2>
        <button class="copy-btn" onclick="copyGroceryList()">Copy List</button>
        <ul id="grocery-list" class="grocery-list">
            <!-- Generated grocery list will appear here -->
        </ul>
    </div>
</div>

<script>
    let allRecipes = [];
    let selectedRecipes = [];
    let ingredientsData = {};
    
    // Load all recipes
    async function loadRecipes() {
        const response = await fetch('/api/recipes-with-ingredients');
        allRecipes = await response.json();
    }
    
    // Search functionality
    document.getElementById('recipe-search').addEventListener('input', function(e) {
        const searchValue = e.target.value.toLowerCase().trim();
        const dropdown = document.getElementById('search-dropdown');
        
        if (searchValue === '') {
            dropdown.classList.remove('show');
            return;
        }
        
        const results = allRecipes.filter(recipe => 
            recipe.name.toLowerCase().includes(searchValue)
        );
        
        if (results.length === 0) {
            dropdown.innerHTML = '<div style="padding: 12px; color: #999;">No recipes found</div>';
            dropdown.classList.add('show');
            return;
        }
        
        dropdown.innerHTML = results.map(recipe => {
            let thumbHTML;
            if (recipe.thumbnail_url) {
                thumbHTML = `<img src="${recipe.thumbnail_url}" class="dropdown-item-thumb">`;
            } else {
                thumbHTML = `<div class="dropdown-item-thumb">${recipe.name[0].toUpperCase()}</div>`;
            }
            
            return `
                <div class="dropdown-item" onclick="selectRecipe(${recipe.id})">
                    ${thumbHTML}
                    <div class="dropdown-item-info">
                        <div class="dropdown-item-name">${recipe.name}</div>
                        <div class="dropdown-item-meta">${recipe.ingredients.length} ingredients</div>
                    </div>
                </div>
            `;
        }).join('');
        
        dropdown.classList.add('show');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
            document.getElementById('search-dropdown').classList.remove('show');
        }
    });
    
    function selectRecipe(recipeId, multiplier = 1) {
        // Check if already selected
        const existing = selectedRecipes.find(r => r.id === recipeId);
        if (existing) {
            existing.multiplier = (existing.multiplier || 1) + multiplier;
            updateSelectedRecipes();
            updateIngredientsTable();
            return;
        }
        
        const recipe = allRecipes.find(r => r.id === recipeId);
        selectedRecipes.push({ ...recipe, multiplier: multiplier });
        
        // Clear search
        document.getElementById('recipe-search').value = '';
        document.getElementById('search-dropdown').classList.remove('show');
        
        updateSelectedRecipes();
        updateIngredientsTable();
    }
    
    function increaseMultiplier(recipeId) {
        const recipe = selectedRecipes.find(r => r.id === recipeId);
        if (recipe) {
            recipe.multiplier = (recipe.multiplier || 1) + 1;
            updateSelectedRecipes();
            updateIngredientsTable();
        }
    }
    
    function decreaseMultiplier(recipeId) {
        const recipe = selectedRecipes.find(r => r.id === recipeId);
        if (recipe) {
            recipe.multiplier = (recipe.multiplier || 1) - 1;
            if (recipe.multiplier <= 0) {
                selectedRecipes = selectedRecipes.filter(r => r.id !== recipeId);
            }
            updateSelectedRecipes();
            updateIngredientsTable();
        }
    }
    
    function updateSelectedRecipes() {
        const container = document.getElementById('selected-recipes');
        
        if (selectedRecipes.length === 0) {
            container.innerHTML = '';
            container.classList.add('empty');
            return;
        }
        
        container.classList.remove('empty');
        container.innerHTML = selectedRecipes.map(recipe => `
            <div class="recipe-tag">
                <span class="recipe-tag-name">${recipe.name}</span>
                <div class="recipe-tag-controls">
                    <span class="recipe-tag-btn" onclick="decreaseMultiplier(${recipe.id})">‚àí</span>
                    <span class="recipe-tag-count">${recipe.multiplier || 1}</span>
                    <span class="recipe-tag-btn" onclick="increaseMultiplier(${recipe.id})">+</span>
                </div>
            </div>
        `).join('');
    }
    
    function updateIngredientsTable() {
        const container = document.getElementById('ingredients-container');
        
        if (selectedRecipes.length === 0) {
            container.innerHTML = '<div class="no-ingredients">Select recipes to see ingredients</div>';
            document.getElementById('grocery-list-section').classList.remove('show');
            return;
        }
        
        // Aggregate ingredients
        ingredientsData = {};
        
        selectedRecipes.forEach(recipe => {
            const multiplier = recipe.multiplier || 1;
            recipe.ingredients.forEach(ing => {
                const key = `${ing.name.toLowerCase()}-${ing.unit}`;
                const adjustedQuantity = (parseFloat(ing.quantity) || 0) * multiplier;
                if (ingredientsData[key]) {
                    ingredientsData[key].quantity += adjustedQuantity;
                } else {
                    ingredientsData[key] = {
                        name: ing.name,
                        quantity: adjustedQuantity,
                        unit: ing.unit,
                        have: 0,
                        skip: false
                    };
                }
            });
        });
        
        // Create table
        let tableHTML = `
            <table class="ingredients-table">
                <thead>
                    <tr>
                        <th>Ingredient</th>
                        <th>Need</th>
                        <th>Unit</th>
                        <th>Have</th>
                        <th>Skip</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        // Sort ingredients alphabetically by name
        const sortedKeys = Object.keys(ingredientsData).sort((a, b) => 
            ingredientsData[a].name.localeCompare(ingredientsData[b].name)
        );
        
        sortedKeys.forEach(key => {
            const ing = ingredientsData[key];
            tableHTML += `
                <tr>
                    <td>${ing.name}</td>
                    <td>${ing.quantity.toFixed(2)}</td>
                    <td>${ing.unit}</td>
                    <td><input type="number" step="0.01" value="${ing.have}" data-key="${key}" onchange="updateHave(this)"></td>
                    <td><input type="checkbox" data-key="${key}" onchange="updateSkip(this)"></td>
                </tr>
            `;
        });
        
        tableHTML += `
                </tbody>
            </table>
            <button class="generate-btn" onclick="generateGroceryList()">Generate Grocery List</button>
        `;
        
        container.innerHTML = tableHTML;
    }
    
    function updateHave(input) {
        const key = input.dataset.key;
        ingredientsData[key].have = parseFloat(input.value) || 0;
    }
    
    function updateSkip(input) {
        const key = input.dataset.key;
        ingredientsData[key].skip = input.checked;
    }
    
    function generateGroceryList() {
        // Confirm before generating
        if (!confirm('Generating a new grocery list will replace the previous one on the homepage. Continue?')) {
            return;
        }
        
        const groceryList = document.getElementById('grocery-list');
        const section = document.getElementById('grocery-list-section');
        
        const itemsNeeded = [];
        
        Object.keys(ingredientsData).forEach(key => {
            const ing = ingredientsData[key];
            if (ing.skip) return;
            
            const needed = ing.quantity - ing.have;
            if (needed > 0) {
                itemsNeeded.push({
                    name: ing.name,
                    amount: needed.toFixed(2),
                    unit: ing.unit
                });
            }
        });
        
        // Sort alphabetically by name
        itemsNeeded.sort((a, b) => a.name.localeCompare(b.name));
        
        if (itemsNeeded.length === 0) {
            groceryList.innerHTML = '<li style="text-align: center; color: #4CAF50;">‚úì You have everything you need!</li>';
        } else {
            groceryList.innerHTML = itemsNeeded.map(item => `
                <li>
                    <span class="grocery-item-name">${item.name}</span>
                    <span class="grocery-item-amount">${item.amount} ${item.unit}</span>
                </li>
            `).join('');
        }
        
        // Save grocery list to database
        if (itemsNeeded.length > 0) {
            fetch('/api/grocery-list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ items: itemsNeeded })
            });
        }
        
        section.classList.add('show');
        section.scrollIntoView({ behavior: 'smooth' });
    }
    
    function copyGroceryList() {
        const itemsNeeded = [];
        
        Object.keys(ingredientsData).forEach(key => {
            const ing = ingredientsData[key];
            if (ing.skip) return;
            
            const needed = ing.quantity - ing.have;
            if (needed > 0) {
                itemsNeeded.push(`${ing.name}, ${needed.toFixed(2)}${ing.unit}`);
            }
        });
        
        if (itemsNeeded.length === 0) {
            alert('No items in your grocery list!');
            return;
        }
        
        const text = itemsNeeded.join('\n');
        navigator.clipboard.writeText(text).then(() => {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Copied!';
            btn.classList.add('copied');
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('copied');
            }, 2000);
        });
    }
    
    // Check for recipe IDs from URL parameters (from calendar)
    async function checkURLParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const recipeIds = urlParams.get('recipes');
        
        if (recipeIds) {
            await loadRecipes();
            const ids = recipeIds.split(',').map(id => parseInt(id));
            
            // Count occurrences of each recipe ID
            const recipeCounts = {};
            ids.forEach(id => {
                recipeCounts[id] = (recipeCounts[id] || 0) + 1;
            });
            
            // Add recipes with their counts
            Object.keys(recipeCounts).forEach(id => {
                const recipeId = parseInt(id);
                const recipe = allRecipes.find(r => r.id === recipeId);
                if (recipe && !selectedRecipes.find(r => r.id === recipeId)) {
                    selectedRecipes.push({ ...recipe, multiplier: recipeCounts[id] });
                }
            });
            
            updateSelectedRecipes();
            updateIngredientsTable();
            // Clear URL parameters
            window.history.replaceState({}, '', window.location.pathname);
        }
    }
    
    // Initialize
    loadRecipes();
    checkURLParams();
</script>
{% endblock %}
